<!DOCTYPE html>
<!--
                                                      _
__   ___ __ ___   __ _  __ _  __ _ _ __ ___   ___  __| | _____   __
\ \ / / '_ ` _ \ / _` |/ _` |/ _` | '_ ` _ \ / _ \/ _` |/ _ \ \ / /
 \ V /| | | | | | (_| | (_| | (_| | | | | | |  __/ (_| | (_) \ V /
  \_/ |_| |_| |_|\__,_|\__, |\__,_|_| |_| |_|\___|\__,_|\___/ \_/
                       |___/
                                     Yet another software developer
-->
<html>
    <head>
        <title>vmagamedov - Контекстное программирование</title>
        <meta charset="utf-8">
        <meta name="description" content="">
        <meta name="author" content="" />
        <link rel="shortcut icon" href="/static/favicon.gif?ver=1">
        <link rel="stylesheet" type="text/css" href="../../../static/css/reset.css">
        <link rel="stylesheet" type="text/css" href="../../../static/fonts/fonts.css">
        <link rel="stylesheet" type="text/css" href="../../../static/css/styles.css">
        <link rel="stylesheet" type="text/css" href="../../../static/css/pygments.css">
        <!--<script src="http://yui.yahooapis.com/3.2.0/build/yui/yui-min.js"></script>-->
        <!--<script type="text/javascript" src="/static/js/..."></script>-->
        <link rel="openid.server" href="http://openid.yandex.ru/server/" />
        <link rel="openid2.provider" href="http://openid.yandex.ru/server/" />
        <link rel="openid.delegate" href="http://openid.yandex.ru/vmagamedov/" />
        <link rel="openid2.local_id" href="http://openid.yandex.ru/vmagamedov/" />
    </head>
    <body>
        <div id="wrapper">
            <div id="header">
                <h3><a href="/">~<span>v</span>magamedov</a></h3>
                <p>Yet another software developer</p>
                <div id="nav">
                    <ul>
                        <li><a href="http://www.linkedin.com/in/vmagamedov" target="_blank">LinkedIn</a></li>
                        <li><a href="http://vmagamedov.moikrug.ru/" target="_blank">МойКруг</a></li>
                        <li><a href="http://twitter.com/vmagamedov" target="_blank">Twitter</a></li>
                        <li><a href="https://bitbucket.org/vmagamedov" target="_blank">Bitbucket</a></li>
                    </ul>
                </div>
            </div>
            <div id="content">
                
                    <div id="main">
                        <div class="post">
                            <div class="side">
                                
<sup>new</sup> <a href="../i18n_py/" title="Интернационализация приложений">i18n py</a><br/>
                            </div>
                            <div class="title">
                                <h1>Контекстное программирование <sup>draft</sup></h1>
                                <script type="text/javascript" src="//yandex.st/share/share.js" charset="utf-8"></script>
                                <div class="yashare-auto-init" data-yashareL10n="ru" data-yashareType="icon" data-yashareQuickServices="facebook,twitter"></div>
                                <div class="clear"></div>
                            </div>
                            <div class="body">
    <p>Наверное стоит сразу отметить, что данная тема не нова и уже была описана
Ф. Эби (Phillip J. Eby) в короткой документации к его библиотеке
<a class="reference external" href="http://pypi.python.org/pypi/Contextual">Contextual</a> + наверное уже много где обсуждалась в сети.</p>
<p>Итак, своими словами, контекстное программирование - это возможность писать
код, поведение которого можно менять ничего не переписывая и не прибегая к
monkey patching-у. С его помощью код становится максимально гибким, ничего
не теряя при этом.</p>
<p>Но как разработчики обычно решают такие проблемы? Для этого уже давно есть
соответствующие принципы (паттерны) программирования, такие как Inversion of
control (или ещё говорят Dependency injection). Конкретные реализации этого
принципа как бы решают данную проблему, но решение выглядит обычно не очень
красиво, зато очень громоздко и сложно.</p>
<p>Чего же нам хочется? Как получить то, что нам надо, причём самым простым
способом? Главное - это наше API и требования к нему.
Возьмём самый простой пример:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">context</span>

<span class="n">b</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">ual</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c"># 1 - default value</span>

<span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">**</span><span class="n">b</span>

<span class="k">assert</span> <span class="n">foo</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
<span class="k">with</span> <span class="n">context</span><span class="o">.</span><span class="n">new</span><span class="p">({</span><span class="n">b</span><span class="p">:</span> <span class="mi">3</span><span class="p">}):</span>
    <span class="k">assert</span> <span class="n">foo</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span>
<span class="k">assert</span> <span class="n">foo</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
</pre></div>
<p>Как мы видим, у нас есть функция foo, которая умеет возводить числа в
степень. Также, у нас есть контекстная переменная b, от которой зависит, в
какую степень будет возведено число. Для того, чтобы поменять поведение
функции, мы входим в контекст, где значение переменной b переопределено с 1
на 3, и поэтому в контексте мы получили 8, а не 2, как было до входа. Далее,
после выхода из контекста, функция ведёт себя как и прежде, т.е. возводит в
1-ю степень.</p>
<p>Данный пример не имеет особой ценности, однако существует огромное
количество задач, где данная техника даёт свои результаты. Особенно это
помогает писать новый код - так можно очень быстро описывать функционал, и
не задумываться над его конфигурацией и деталями реализации других частей
проекта.</p>
<p>Вот пример из жизни:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">context</span>

<span class="n">locale</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">ual</span><span class="p">(</span><span class="s">&#39;en&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">gettext</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="n">tr</span> <span class="o">=</span> <span class="n">get_translations</span><span class="p">(</span><span class="n">locale</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tr</span><span class="o">.</span><span class="n">gettext</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</pre></div>
<p>В этом примере мы не задумываемся о том, как, кто, когда и где будет
устанавливать текущую локаль пользователя, откуда она будет браться и т.д.</p>
<p>Все эти так называемые требования уже реализованы и ими, в принципе, можно
пользоваться, однако стоит предупредить, что приведённая реализация - это
лишь пример, который можно использовать только на свой страх и риск.</p>
<div class="section" id="faq">
<h2>FAQ:</h2>
<p><em>Как ведут себя эти контекстные переменные в многопоточной программе?</em></p>
<p>Каждый поток имеет собственный контекст, поэтому потоки друг другу
совершенно не мешают. Если в программе используются сопрограммы (coroutines),
то и это не проблема.</p>
<p><em>Зачем было писать что-то своё, когда есть Contextual?</em></p>
<p>Получилось довольно много отличий, но самое главное - это то, как создаётся
новый контекст и как в нём меняются значения переменных. В Contextual новый
контекст создаётся пустым, т.е. все переменные изначально имеют старые
значения, и потом, находясь в новом контексте, разработчик имеет возможность
поменять любую переменную, но только один раз. Тут теряется некоторая
явность того, что происходит, т.к. переменная может измениться где угодно в
программе и как угодно далеко от того места, где был создан контекст. Плюс к
этому, при попытке повторно изменить значение переменной, мы можем получить
исключение, которое не ожидали, а исследование подобных исключений может
стать нетривиальной задачей. В нашей реализации всё совсем иначе, контекст
создаётся явно с конкретным перечнем переменных, который в дальнейшем уже не
меняется. Если надо изменить значение переменной - без создания нового
контекста не обойтись. Поэтому код остаётся таким же понятным и никакой
магии не происходит.</p>
<p><em>Где это может понадобится и можно ли этим вылечить какой-то уже
существующий проект, фреймворк или библиотеку?</em></p>
<p>Использовать этот подход можно везде, один из лучших примеров использования
- это веб-разработка, т.к. в этой области мы имеем почти идеальные условия:
одна точка входа в программу (обработчик запросов) и сильно меняющиеся
данные между запросами (таже локаль пользователя, временная зона,
географическое положение и т.д.). Теоретически вылечить можно всё, но
начинать что-то менять надо с себя, если конечно вы не работаете с Django;)</p>
</div>
<div class="section" id="id1">
<h2>Что дальше?</h2>
<p>В последнее время всё чаще децентрализованные системы показывают себя лучше
чем централизованные. Тут тоже есть над чем подумать. Вспомните как вы
осуществляете конфигурацию своего проекта - это обычно какой-то глобальный
объект в приложении, где зачастую все настройки хранятся в плоском виде (в
одном пространстве имён). Это тоже централизованная система, настройки лежат
далеко от того кода, где они собственно и используются. Связь между ними
иногда очень трудно прощупать, она бывает не явная, и хорошо когда
задокументирована. В качестве примера можно вспомнить ту же Django (прошу
прощения у пользователей Django, но других столь явно плохих в этом плане
примеров я не знаю), всё в одном месте и в одном пространстве имён, чтобы
дать понять какому приложению принадлежит настройка, приходится в имени
настройки писать название приложения и возможно ещё кое-что, чтобы объяснить
к чему настройка относится - получается длинное и не сильно информативное
название, которое приходится потом везде в коде указывать. Чем тут может
помочь децентрализация и как она может выглядеть? А очень просто - в
качестве настроек выступают контекстные переменные, которые лежат в своих
модулях и оттуда же импортируются. Для сравнения:</p>
<p>Django-стиль:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>

<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">use</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MYAPP_NEED_THIS_MYSETTING</span><span class="p">)</span>
</pre></div>
<p>Наш стиль:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">myapp.module</span> <span class="kn">import</span> <span class="n">mysetting</span>

<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">use</span><span class="p">(</span><span class="n">mysetting</span><span class="p">)</span>
</pre></div>
<p>Настройки лежат там, где им и место, а установить их можно в том месте,
где разработчику будет удобнее это сделать:)</p>
</div>

    <script>
    var idcomments_acct = '8049abdc3f320e75fa895cb52765eb85';
    var idcomments_post_id;
    var idcomments_post_url;
    </script>
    <span id="IDCommentsPostTitle" style="display:none"></span>
    <script type='text/javascript' src='http://www.intensedebate.com/js/genericCommentWrapperV2.js'></script>
</div>
                        </div>
                    </div>
                
            </div>
            <div id="footer">
                
                    Copyright &copy; 2011 Vladimir Magamedov,
                    powered by <a href="http://pypi.python.org/pypi/cyrax" target="_blank">Cyrax</a>
                
            </div>
        </div>
        <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-6339170-1']);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
  })();
</script>
<!-- Yandex.Metrika -->
<script src="//mc.yandex.ru/metrika/watch.js" type="text/javascript"></script>
<div style="display:none;"><script type="text/javascript">
try { var yaCounter1296707 = new Ya.Metrika(1296707); } catch(e){}
</script></div>
<noscript><div style="position:absolute"><img src="//mc.yandex.ru/watch/1296707" alt="" /></div></noscript>
<!-- /Yandex.Metrika -->
        
    </body>
</html>